<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Work Tracker - Auto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0a0a0f; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
    .card { background: #141420; border: 1px solid #1e1e30; border-radius: 8px; }
    .agent-nox { color: #3B82F6; }
    .agent-sage { color: #10B981; }
    .agent-joy { color: #8B5CF6; }
    .tab-active { border-bottom: 2px solid #3B82F6; color: #3B82F6; }
    .activity-item { transition: background 0.15s; }
    .activity-item:hover { background: #1a1a2e; }
    /* Virtual scrolling container */
    #activity-feed { height: 600px; overflow-y: auto; position: relative; }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-50 bg-gray-900 border-b border-gray-800">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold">üî® Work Tracker</h1>
          <p class="text-xs text-gray-500">Auto-tracking: Nox, Sage, Joy</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="activity-count" class="text-xs text-gray-400">Loading...</span>
          <button onclick="refreshData()" class="px-3 py-1 bg-gray-800 rounded text-sm hover:bg-gray-700">üîÑ Refresh</button>
          <button onclick="runCleanup()" class="px-3 py-1 bg-red-900/50 text-red-200 rounded text-sm hover:bg-red-800">üßπ Cleanup</button>
        </div>
      </div>
    </div>
    <nav class="max-w-7xl mx-auto px-4">
      <div class="flex space-x-1">
        <button onclick="showTab('all')" id="tab-btn-all" class="tab-btn px-4 py-2 text-sm tab-active">üìä All</button>
        <button onclick="showTab('nox')" id="tab-btn-nox" class="tab-btn px-4 py-2 text-sm">‚ö° Nox</button>
        <button onclick="showTab('sage')" id="tab-btn-sage" class="tab-btn px-4 py-2 text-sm">üåø Sage</button>
        <button onclick="showTab('joy')" id="tab-btn-joy" class="tab-btn px-4 py-2 text-sm">‚ú® Joy</button>
        <button onclick="showTab('stats')" id="tab-btn-stats" class="tab-btn px-4 py-2 text-sm">üìà Stats</button>
      </div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Activity Feed -->
    <div id="tab-all" class="tab-content">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Recent Activity</h2>
        <select id="type-filter" onchange="loadActivities()" class="px-3 py-1 bg-gray-800 rounded border border-gray-700 text-sm">
          <option value="">All Types</option>
          <option value="feature">‚ú® Feature</option>
          <option value="bug_fix">üêõ Bug Fix</option>
          <option value="improvement">‚ö° Improvement</option>
          <option value="research">üîç Research</option>
          <option value="documentation">üìù Documentation</option>
          <option value="refactor">‚ôªÔ∏è Refactor</option>
        </select>
      </div>
      <div id="activity-feed" class="card">
        <div class="p-4 text-center text-gray-500">Loading...</div>
      </div>
      <div class="mt-4 flex items-center justify-between">
        <button onclick="prevPage()" id="prev-btn" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 disabled:opacity-50" disabled>‚Üê Previous</button>
        <span id="page-info" class="text-sm text-gray-400">Page 1</span>
        <button onclick="nextPage()" id="next-btn" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 disabled:opacity-50" disabled>Next ‚Üí</button>
      </div>
    </div>

    <!-- Stats Tab -->
    <div id="tab-stats" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-4">üìà Statistics</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card p-4">
          <h3 class="text-sm text-gray-400 mb-2">Total Activities</h3>
          <p id="stat-total" class="text-3xl font-bold">-</p>
        </div>
        <div class="card p-4">
          <h3 class="text-sm text-gray-400 mb-2">Today</h3>
          <p id="stat-today" class="text-3xl font-bold">-</p>
        </div>
        <div class="card p-4">
          <h3 class="text-sm text-gray-400 mb-2">This Week</h3>
          <p id="stat-week" class="text-3xl font-bold">-</p>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-4">
          <h3 class="text-sm text-gray-400 mb-4">By Agent</h3>
          <canvas id="chart-agents"></canvas>
        </div>
        <div class="card p-4">
          <h3 class="text-sm text-gray-400 mb-4">By Type</h3>
          <canvas id="chart-types"></canvas>
        </div>
      </div>
    </div>
  </main>

  <script>
    // State
    let currentTab = 'all';
    let currentPage = 0;
    let pageSize = 100;
    let totalActivities = 0;
    let chartInstances = {};

    // Tab switching
    function showTab(tab) {
      currentTab = tab;
      currentPage = 0;
      
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('tab-active'));
      
      if (tab === 'stats') {
        document.getElementById('tab-stats').classList.remove('hidden');
        loadStats();
      } else {
        document.getElementById('tab-all').classList.remove('hidden');
        loadActivities();
      }
      
      document.getElementById(`tab-btn-${tab}`).classList.add('tab-active');
    }

    // Load activities with pagination
    async function loadActivities() {
      const feed = document.getElementById('activity-feed');
      feed.innerHTML = '<div class="p-4 text-center text-gray-500">Loading...</div>';
      
      const typeFilter = document.getElementById('type-filter').value;
      const agentFilter = currentTab === 'all' ? '' : currentTab;
      
      try {
        const url = `/api/activities?limit=${pageSize}&offset=${currentPage * pageSize}` +
                    (agentFilter ? `&agent=${agentFilter}` : '') +
                    (typeFilter ? `&type=${typeFilter}` : '');
        
        const res = await fetch(url);
        const data = await res.json();
        
        totalActivities = data.total || 0;
        renderActivities(data.entries || []);
        updatePagination();
        
        document.getElementById('activity-count').textContent = 
          `${data.entries?.length || 0} of ${totalActivities} activities`;
      } catch (err) {
        console.error('Failed to load:', err);
        feed.innerHTML = '<div class="p-4 text-center text-red-400">Failed to load</div>';
      }
    }

    // Render activities (virtualized - only visible items)
    function renderActivities(entries) {
      const feed = document.getElementById('activity-feed');
      
      if (entries.length === 0) {
        feed.innerHTML = '<div class="p-4 text-center text-gray-500">No activities</div>';
        return;
      }
      
      const html = entries.map((a, i) => {
        const time = new Date(a.timestamp).toLocaleString('en-US', { 
          month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        const agentColor = a.agent === 'nox' ? 'agent-nox' : 
                          a.agent === 'sage' ? 'agent-sage' : 
                          a.agent === 'joy' ? 'agent-joy' : '';
        
        return `
          <div class="activity-item p-3 border-b border-gray-800 ${i % 2 === 0 ? 'bg-gray-900/30' : ''}">
            <div class="flex items-start justify-between">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="${agentColor} font-bold text-xs">${(a.agent || 'unknown').toUpperCase()}</span>
                  <span class="text-xs text-gray-500">${time}</span>
                  ${a.project ? `<span class="text-xs text-gray-600">${a.project}</span>` : ''}
                </div>
                <p class="text-sm text-gray-300 truncate">${a.description || a.title || 'No description'}</p>
              </div>
              ${a.commit_hash ? `<span class="text-xs text-gray-600 ml-2">${a.commit_hash.substring(0, 7)}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      feed.innerHTML = html;
    }

    // Update pagination buttons
    function updatePagination() {
      const maxPage = Math.ceil(totalActivities / pageSize) - 1;
      document.getElementById('prev-btn').disabled = currentPage <= 0;
      document.getElementById('next-btn').disabled = currentPage >= maxPage;
      document.getElementById('page-info').textContent = `Page ${currentPage + 1} of ${maxPage + 1 || 1}`;
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        loadActivities();
      }
    }

    function nextPage() {
      const maxPage = Math.ceil(totalActivities / pageSize) - 1;
      if (currentPage < maxPage) {
        currentPage++;
        loadActivities();
      }
    }

    // Load stats
    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const stats = await res.json();
        
        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-today').textContent = stats.today || 0;
        document.getElementById('stat-week').textContent = stats.thisWeek || 0;
        
        renderCharts(stats);
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    // Render charts
    function renderCharts(stats) {
      // Destroy existing charts
      if (chartInstances.agents) chartInstances.agents.destroy();
      if (chartInstances.types) chartInstances.types.destroy();
      
      // Agent chart
      const agentCtx = document.getElementById('chart-agents')?.getContext('2d');
      if (agentCtx && stats.byAgent) {
        chartInstances.agents = new Chart(agentCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(stats.byAgent),
            datasets: [{
              data: Object.values(stats.byAgent),
              backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B']
            }]
          },
          options: { plugins: { legend: { labels: { color: '#e2e8f0' } } } }
        });
      }
      
      // Type chart
      const typeCtx = document.getElementById('chart-types')?.getContext('2d');
      if (typeCtx && stats.byType) {
        chartInstances.types = new Chart(typeCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(stats.byType),
            datasets: [{
              label: 'Activities',
              data: Object.values(stats.byType),
              backgroundColor: '#3B82F6'
            }]
          },
          options: {
            plugins: { legend: { labels: { color: '#e2e8f0' } } },
            scales: {
              y: { ticks: { color: '#e2e8f0' } },
              x: { ticks: { color: '#e2e8f0' } }
            }
          }
        });
      }
    }

    // Refresh data
    function refreshData() {
      if (currentTab === 'stats') {
        loadStats();
      } else {
        loadActivities();
      }
    }

    // Run cleanup
    async function runCleanup() {
      if (!confirm('Remove activities older than 7 days?')) return;
      
      try {
        const res = await fetch('/api/cleanup', { method: 'POST' });
        const result = await res.json();
        alert(`Removed ${result.removed} old activities. ${result.remaining} remaining.`);
        refreshData();
      } catch (err) {
        alert('Cleanup failed');
      }
    }

    // Initial load
    loadActivities();
  </script>
</body>
</html>
