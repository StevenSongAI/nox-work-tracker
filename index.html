<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Cache-busting meta tags to prevent stale data -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="cache-version" content="2026-02-14-v3-forced">
  <title>Work Tracker - Auto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0a0a0f; color: #e2e8f0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; }
    .tab-active { border-bottom: 2px solid #3B82F6; color: #3B82F6; }
    .card { background: #141420; border: 1px solid #1e1e30; }
    .agent-nox { color: #3B82F6; }
    .agent-sage { color: #10B981; }
    .agent-joy { color: #8B5CF6; }
    .type-feature { color: #10B981; }
    .type-bug_fix { color: #EF4444; }
    .type-improvement { color: #3B82F6; }
    .type-research { color: #F59E0B; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Cache-busting check: Force reload if this is cached HTML -->
  <script>
    (function() {
      const EXPECTED_CACHE_VERSION = 'v3-forced';
      const urlParams = new URLSearchParams(window.location.search);
      
      // If no cache-busting param in URL, check if we need to force reload
      if (!urlParams.has('_cb')) {
        // Add cache-busting param and reload
        urlParams.set('_cb', EXPECTED_CACHE_VERSION + '-' + Date.now());
        const newUrl = window.location.pathname + '?' + urlParams.toString();
        console.log('[Cache] Force reloading with cache-bust:', newUrl);
        window.location.replace(newUrl);
      }
    })();
  </script>
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-dark-900 border-b border-dark-700">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold">üî® Work Tracker</h1>
          <p class="text-xs text-gray-500">Auto-tracking: Nox, Sage, Joy</p>
        </div>
        <div class="flex items-center gap-4">
          <div id="live-indicator" class="flex items-center gap-2 text-sm">
            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-gray-400">AUTO</span>
          </div>
          <div id="freshness-indicator" class="hidden sm:flex" title="Data freshness">
            <span class="text-green-400 text-xs">‚óè Fresh</span>
          </div>
          <button onclick="clearAllCaches()" class="px-3 py-1 bg-red-900/50 hover:bg-red-800 text-red-200 rounded text-sm" title="Clear cache & hard reload">üóëÔ∏è Cache</button>
          <button onclick="refreshData()" class="px-3 py-1 bg-dark-700 rounded text-sm hover:bg-dark-600">üîÑ</button>
        </div>
      </div>
    </div>
    <!-- Tab Navigation -->
    <nav class="max-w-7xl mx-auto px-4">
      <div class="flex space-x-1">
        <button onclick="showTab('all')" id="tab-btn-all" class="tab-btn px-4 py-2 text-sm tab-active">üìä All Activity</button>
        <button onclick="showTab('nox')" id="tab-btn-nox" class="tab-btn px-4 py-2 text-sm">‚ö° Nox</button>
        <button onclick="showTab('sage')" id="tab-btn-sage" class="tab-btn px-4 py-2 text-sm">üåø Sage</button>
        <button onclick="showTab('joy')" id="tab-btn-joy" class="tab-btn px-4 py-2 text-sm">‚ú® Joy</button>
        <button onclick="showTab('stats')" id="tab-btn-stats" class="tab-btn px-4 py-2 text-sm">üìà Stats</button>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Activity Feed (All Agents) -->
    <div id="tab-all" class="tab-content">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold">Live Activity Feed</h2>
        <select id="type-filter" onchange="filterActivities()" class="px-3 py-1 bg-dark-700 rounded border border-dark-600 text-sm">
          <option value="">All Types</option>
          <option value="feature">üü¢ Feature</option>
          <option value="bug_fix">üî¥ Bug Fix</option>
          <option value="improvement">üîµ Improvement</option>
          <option value="research">üü† Research</option>
          <option value="documentation">üìÑ Documentation</option>
          <option value="refactor">‚ôªÔ∏è Refactor</option>
        </select>
      </div>
      <div id="activity-feed-all" class="space-y-2">
        <div class="card rounded p-4 text-center text-gray-500">Loading...</div>
      </div>
    </div>

    <!-- Nox Activity -->
    <div id="tab-nox" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4 agent-nox">‚ö° Nox Activity</h2>
      <div id="activity-feed-nox" class="space-y-2">
        <div class="card rounded p-4 text-center text-gray-500">Loading...</div>
      </div>
    </div>

    <!-- Sage Activity -->
    <div id="tab-sage" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4 agent-sage">üåø Sage Activity</h2>
      <div id="activity-feed-sage" class="space-y-2">
        <div class="card rounded p-4 text-center text-gray-500">Loading...</div>
      </div>
    </div>

    <!-- Joy Activity -->
    <div id="tab-joy" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4 agent-joy">‚ú® Joy Activity</h2>
      <div id="activity-feed-joy" class="space-y-2">
        <div class="card rounded p-4 text-center text-gray-500">Loading...</div>
      </div>
    </div>

    <!-- Stats -->
    <div id="tab-stats" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-4">üìà Statistics</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card rounded p-4">
          <h3 class="text-sm text-gray-400 mb-2">Total Activities</h3>
          <p id="stat-total" class="text-3xl font-bold">0</p>
        </div>
        <div class="card rounded p-4">
          <h3 class="text-sm text-gray-400 mb-2">Today</h3>
          <p id="stat-today" class="text-3xl font-bold">0</p>
        </div>
        <div class="card rounded p-4">
          <h3 class="text-sm text-gray-400 mb-2">This Week</h3>
          <p id="stat-week" class="text-3xl font-bold">0</p>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card rounded p-4">
          <h3 class="text-sm text-gray-400 mb-4">Activities by Agent</h3>
          <canvas id="chart-agents"></canvas>
        </div>
        <div class="card rounded p-4">
          <h3 class="text-sm text-gray-400 mb-4">Activities by Type</h3>
          <canvas id="chart-types"></canvas>
        </div>
      </div>
    </div>
  </main>

  <script>
    let activities = [];
    let currentTab = 'all';
    let typeFilter = '';
    let chartInstances = {};

    // Tab Management
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('tab-active'));
      
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      document.getElementById('tab-btn-' + tabName).classList.add('tab-active');
      
      currentTab = tabName;
      renderActivities();
    }

    // Load Data
    async function loadData() {
      try {
        const response = await fetch('data/activity-log.json?t=' + Date.now());
        const data = await response.json();
        activities = data.entries || [];
        renderActivities();
        renderStats();
      } catch (error) {
        console.error('Failed to load activities:', error);
      }
    }

    // Filter Activities
    function filterActivities() {
      typeFilter = document.getElementById('type-filter').value;
      renderActivities();
    }

    // Render Activities
    function renderActivities() {
      let filtered = activities;

      // Filter by type
      if (typeFilter) {
        filtered = filtered.filter(a => a.type === typeFilter);
      }

      // Filter by agent (tab)
      if (currentTab !== 'all' && currentTab !== 'stats') {
        filtered = filtered.filter(a => a.agent === currentTab);
      }

      // Render to appropriate feed
      const feedId = currentTab === 'all' || currentTab === 'stats' ? 'activity-feed-all' : `activity-feed-${currentTab}`;
      const feedEl = document.getElementById(feedId);
      
      if (filtered.length === 0) {
        feedEl.innerHTML = '<div class="card rounded p-4 text-center text-gray-500">No activities found</div>';
        return;
      }

      feedEl.innerHTML = filtered.map(activity => {
        const timestamp = new Date(activity.timestamp);
        const timeStr = timestamp.toLocaleString('en-US', { 
          month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
        });
        
        const agentColor = activity.agent === 'nox' ? 'agent-nox' : 
                          activity.agent === 'sage' ? 'agent-sage' : 
                          activity.agent === 'joy' ? 'agent-joy' : '';
        
        const typeIcon = activity.type === 'feature' ? 'üü¢' :
                        activity.type === 'bug_fix' ? 'üî¥' :
                        activity.type === 'improvement' ? 'üîµ' :
                        activity.type === 'research' ? 'üü†' :
                        activity.type === 'documentation' ? 'üìÑ' :
                        activity.type === 'refactor' ? '‚ôªÔ∏è' : '‚ö™';
        
        return `
          <div class="card rounded p-3 hover:bg-dark-700 transition-colors">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="${agentColor} font-bold text-sm">${(activity.agent || 'unknown').toUpperCase()}</span>
                  <span class="text-xs text-gray-500">${timeStr}</span>
                  ${activity.project ? `<span class="text-xs text-gray-600">${activity.project}</span>` : ''}
                </div>
                <div class="flex items-start gap-2">
                  <span>${typeIcon}</span>
                  <p class="text-sm text-gray-300">${activity.description}</p>
                </div>
              </div>
              ${activity.commit_hash ? `<span class="text-xs text-gray-600 ml-2">${activity.commit_hash}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Render Stats
    function renderStats() {
      // Destroy existing charts to prevent canvas reuse errors
      if (chartInstances.agents) {
        chartInstances.agents.destroy();
      }
      if (chartInstances.types) {
        chartInstances.types.destroy();
      }

      // Total
      document.getElementById('stat-total').textContent = activities.length;

      // Today
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayActivities = activities.filter(a => new Date(a.timestamp) >= today);
      document.getElementById('stat-today').textContent = todayActivities.length;

      // This Week
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const weekActivities = activities.filter(a => new Date(a.timestamp) >= weekAgo);
      document.getElementById('stat-week').textContent = weekActivities.length;

      // Agent Chart
      const agentCounts = {};
      activities.forEach(a => {
        agentCounts[a.agent] = (agentCounts[a.agent] || 0) + 1;
      });

      const ctxAgents = document.getElementById('chart-agents').getContext('2d');
      chartInstances.agents = new Chart(ctxAgents, {
        type: 'doughnut',
        data: {
          labels: Object.keys(agentCounts),
          datasets: [{
            data: Object.values(agentCounts),
            backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6']
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e2e8f0' } } }
        }
      });

      // Type Chart
      const typeCounts = {};
      activities.forEach(a => {
        typeCounts[a.type] = (typeCounts[a.type] || 0) + 1;
      });

      const ctxTypes = document.getElementById('chart-types').getContext('2d');
      chartInstances.types = new Chart(ctxTypes, {
        type: 'bar',
        data: {
          labels: Object.keys(typeCounts),
          datasets: [{
            label: 'Activities',
            data: Object.values(typeCounts),
            backgroundColor: '#3B82F6'
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e2e8f0' } } },
          scales: {
            y: { ticks: { color: '#e2e8f0' } },
            x: { ticks: { color: '#e2e8f0' } }
          }
        }
      });
    }

    // Refresh Data
    function refreshData() {
      loadData();
    }

    // Auto-refresh every 2 minutes
    setInterval(loadData, 120000);

    // Initial load
    loadData();
  </script>
</body>
</html>
